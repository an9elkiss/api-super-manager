<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.an9elkiss.api.manager.dao.TaskDao">


	<insert id="save" parameterType="com.an9elkiss.api.manager.model.Task" useGeneratedKeys="true"
		keyProperty="id">
		INSERT INTO `t_task` 
		(`code`, `title`, `project`, `tags`, `is_parent`, `parent_id`, `description`, `plan_score`, `plan_status`, `plan_hours`, `status`, `create_by`, `update_by`,`percent_hours`) 
		VALUES (#{code}, #{title}, #{project}, #{tags}, #{isParent}, #{parentId}, #{description}, #{planScore}, #{planStatus}, #{planHours}, #{status}, #{createBy}, #{updateBy}, #{percentHours});
	</insert>
	  
	<update id="update" parameterType="com.an9elkiss.api.manager.model.Task">
			UPDATE t_task 
			SET code = code
			<if test="title!=null and title!=''">
				, title = #{title}
			</if>
			<if test="project!=null">
				, project = #{project}
			</if>
			<if test="tags!=null and tags!=''">
				, tags = #{tags}
			</if>
			<if test="isParent!=null and isParent!=''">
				, is_parent = #{isParent}
			</if>
			<if test="parentId!=null">
				, parent_id = #{parentId}
			</if>
			<if test="description!=null and description!=''">
				, description = #{description}
			</if>
			<if test="planScore!=null">
				, plan_score = #{planScore}
			</if>	
			<if test="planStatus!=null">
				, plan_status = #{planStatus}
			</if>	
			<if test="planHours!=null">
				, plan_hours = #{planHours}
			</if>	
			<if test="status!=null and status!=''">
				, status = #{status}
			</if>	
			<if test="createBy!=null and createBy!=''">
				, create_by = #{createBy}
			</if>
			<if test="updateBy!=null and updateBy!=''">
				, update_by = #{updateBy}
			</if>
			<if test="percentHours!=null">
				, percent_hours = #{percentHours}
			</if>
				
			where id=#{id}
	</update>
	
	<delete id="delete" parameterType="Integer">
		DELETE FROM t_task
		WHERE id=#{id}
	</delete>
	
	<select id="findById" parameterType="Integer" resultType="com.an9elkiss.api.manager.model.Task" >
		SELECT id id,
			CODE CODE,
			title title,
			project project,
			tags tags,
			is_parent isParent,
			parent_id parentId,
			description description,
			plan_score planScore,
			plan_status planStatus,
			plan_hours planHours,
			status status,
			create_by createBy,
			create_time createTime,
			update_by updateBy,
			update_time updateTime,
			percent_hours percentHours
		FROM t_task 
		WHERE id = #{id}
	</select>
	
	<select id="findTaskViewCommands" parameterType="java.util.Map" resultType="com.an9elkiss.api.manager.command.TaskViewCommand" >
		SELECT
			wek.id taskWeekId,
			task.id taskId,
			task.CODE CODE,
			task.title title,
			task.parent_id parentId,
			task.is_parent isParent,
			task.project project,
			task.tags tags,
			task.description description,
			task.plan_score planScore,
			wek.actual_score actualScore,
			task.plan_status planStatus,
			wek.current_status currentStatus,
			wek.end_time endTime,
			task.plan_hours planHours,
			wek.actual_hours actualHours,
			wek.user_id userId,
			wek.YEAR YEAR,
			wek.WEEK WEEK,
			wek.MONTH MONTH,
			wek.create_by createBy,
			wek.create_time createTime,
			wek.update_by updateBy,
			wek.update_time updateTime,
			wek.user_name userName,
			task.percent_hours percentHours
		FROM
			t_task task,
			t_task_week wek
		WHERE
			task.id = wek.task_id
			and task.parent_id is null
			and year = #{searchParams.year}
			and month = #{searchParams.month}
			and week = #{searchParams.week}
			and wek.user_id in(${searchParams.memberIds})
		order by wek.user_id
	</select>
	
</mapper>